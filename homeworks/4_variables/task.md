# 4. Переменные

- [4. Переменные](#4-переменные)
- [Переменные](#переменные)
  - [Задание](#задание)
- [Locals](#locals)
  - [Задание](#задание-1)
- [Сложные типы данных в переменных](#сложные-типы-данных-в-переменных)
  - [Задание](#задание-2)
- [Outputs](#outputs)
  - [Задание](#задание-3)
- [Усложняем конфигурацию](#усложняем-конфигурацию)
  - [Задание](#задание-4)

Переменные
=======

Задание
-------

Разберемся на практике как работать с переменными в `Terraform`. Дополните проект из предыдущих заданий так, чтобы пользователь для создания виртуальной машины мог передать в конфигурацию её имя и образ, из которого нужно создавать виртуальную машину.

1. Опишите две переменные `vm_name` и `image_id`. Переменная `image_id` должна содержать в качестве дефолтного значения тот `id` образа, который сейчас указан в файлах проекта. Не забудьте добавить тип и описание для переменных

2. Примените конфигурацию попробовав разные способы указания значений переменных. Для просмотра доступных ID образов в облаке Yandex можно воспользоваться командой:

    ```
    yc compute image list --folder-id standard-images
    ```

3. Не забудьте удалить конфигурацию после завершения задания

Locals
=======

Задание
-------

В этом задании опробуем работу с `locals`. Как говорилось в уроке - `locals` позволяют указывать переменные для переиспользования значений в конфигурации. Давайте объявим локальную переменную для указания префикса у всех объектов, которые мы создаем в проекте. Это поможет отличать все объекты, используемые для практических заданий курса.

1. Добавьте в проект секцию `locals` с переменной `prefix` и значением `slurm-`

2. Дополните конфигурацию всех ресурсов, чтобы в поле `name` использовалась созданная переменная

3. Примените конфигурацию, проверьте, что объекты имеют префикс в названии

4. Удалите созданную инфраструктуру

Сложные типы данных в переменных
=======

Задание
-------

Попробуем на практике создание переменных типов `map`, `list` и `object`. При описании больших инфраструктурных проектов, в которых хорошо продумана возможность переиспользования, использование отдельных переменных с типом `string` и `number` становится нецелесообразно. Гораздо удобнее сгруппировать переменные в блоки. Например для указания всех параметров сетей, виртуальных машин и тд.

1. В своем проекте объявите переменные:

    - `labels` типа `map(string)` со списком лейблов для всех объектов (`project = slurm` и `env = lab`)
    - `resources` типа `object` с полями `cpu`, `memory` и `disk` для конфигурации виртуальных машин
    - `cidr_blocks` типа `list(list(string))` для передачи списка IPv4 подсетей для каждого ресурса `subnet` в конфигурации (первый элемент наружнего списка - подсети для первого сабнета, второй для второго и тд)

    При работе со списками, для обращения к нужному элементу используется конструкция `var.variable_name[index]`. Индексы начинаются с нуля.

2. Скорректируйте описание объектов, для использования созданных переменных.

3. Добавьте значения переменных в `var.tfvars` файл

4. Примените конфигурацию, проверьте корректность применения данных из переменных в UI или с помощью `yc`

5. Удалите инфраструктуру после выполнения задания

Outputs
=======

Задание
-------

Для вывода данных после применения конфигурации, используется конструкция `outputs` (как говорилось в уроке). Ее удобно применять, когда нужно вернуть какие-то параметры созданной инфраструктуры, например IP адреса, по которым можно подключиться к виртуальным машинам. В этом задании мы научимся это делать.

1. Измените конфигурацию виртуальных машин в проекте, чтобы у них были белые IP адреса (см документацию к ресурсу `yandex_compute_instance`)

2. Добавьте вывод белых IP адресов виртуальных машин с помощью `outputs`.

3. После создания инфраструктуры попробуйте подключиться к виртуальным машинам по SSH по выведенным IP

4. По завершении задания, удалите инфраструктуру

Усложняем конфигурацию
=======

Задание
-------

В двух предыдущих заданиях вы собрали плейбук  `Terraform` для создания сети, подсетей по одной в зоне доступности, и виртуальных машин в этих подсетях. Пришло время попробовать новый тип ресурсов - сетевые балансировщики. Они нужны для обеспечения доступа к виртуальным машинам и, как следует из названия, балансировки запросов к виртуальной машине.

1. Добавьте в ваш проект отдельный файл `loadbalancer.tf`

2. Опишите в нем ресурсы `yandex_lb_target_group` и `yandex_lb_network_load_balancer` (см документацию провайдера Yandex Cloud)

3. Подключите описанные виртуальные машины в качестве таргетов для балансировщика.Используйте атрибуты для подсетей и виртуальных машин. Для вм возьмите внутренний IP адрес: `network_interface.0.ip_address`

4. Добавьте для новых ресурсов префикс из `locals` и лейблы из переменных

5. Создайте переменную для указания порта балансировщика (в конфигурации `listener {port = ...}`)

6. Создайте переменную типа `object` для конфигурации хэлсчеков. Например в таком формате:

    ```
    nlb_healthcheck = {
      name   = "test"
      port   = 80
      path   = "/"
    }
    ```

7. Добавьте вывод внешнего адреса балансировщика с помощью `outputs`

8. Примените конфигурацию, проверьте объекты в UI или с помощью `yc`

9. После завершения задания удалите созданную инфраструктуру

**Проверка результата**:
> Так как на виртуальных машинах сейчас у никто не слушает порты и некому отвечать за балансировщиком, виртуальные машины в таргет группах всегда будут неактивны. Для проверки результатов работы вы можете установить на свои виртуальные машины `Nginx` и запустить его с дефолтной конфигурацией. В дальнейших уроках мы научимся интегрировать `Ansible` с `Terraform` для подобных задач.
